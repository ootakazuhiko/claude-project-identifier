#!/bin/bash

# Project Information Display Script
# This script displays project information when Claude Code starts or when called

# è‰²ã®å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# å¤ªå­—
BOLD='\033[1m'

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã‚€
load_project_config() {
    if [ -f ".claude-project" ]; then
        PROJECT_NAME=$(grep -o '"name": "[^"]*"' .claude-project | head -1 | cut -d'"' -f4)
        PROJECT_TYPE=$(grep -o '"type": "[^"]*"' .claude-project | head -1 | cut -d'"' -f4)
        PROJECT_VERSION=$(grep -o '"version": "[^"]*"' .claude-project | head -1 | cut -d'"' -f4)
        PROJECT_STATUS=$(grep -o '"status": "[^"]*"' .claude-project | head -1 | cut -d'"' -f4)
        PROJECT_DESC=$(grep -o '"description": "[^"]*"' .claude-project | head -1 | cut -d'"' -f4)
    else
        PROJECT_NAME="Unknown Project"
        PROJECT_TYPE="Unknown"
        PROJECT_VERSION="0.0.0"
        PROJECT_STATUS="Unknown"
        PROJECT_DESC="No description available"
    fi
}

# å¾…æ©Ÿã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
show_waiting_indicator() {
    indicators=(
        "[WAITING] ğŸ‘ï¸  Ready for your command..."
        "[WAITING] ğŸ¤– Awaiting instructions..."
        "[WAITING] ğŸ’­ What would you like to do?"
        "[WAITING] â³ Standing by..."
        "[WAITING] ğŸ¯ Ready to assist..."
    )
    
    # ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
    RANDOM_INDEX=$((RANDOM % ${#indicators[@]}))
    echo -e "${YELLOW}${indicators[$RANDOM_INDEX]}${NC}"
    echo ""
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®è¡¨ç¤º
show_project_info() {
    clear
    
    # å¾…æ©Ÿã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    show_waiting_indicator
    
    # ãƒãƒŠãƒ¼è¡¨ç¤ºï¼ˆUnicodeå¯¾å¿œãƒã‚§ãƒƒã‚¯ï¼‰
    if [ "${TERM}" != "" ] && command -v tput >/dev/null 2>&1; then
        # Unicodeå¯¾å¿œã®å ´åˆ
        echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${CYAN}â•‘${NC}${PURPLE}${BOLD}                    ${PROJECT_NAME}                    ${NC}${CYAN}â•‘${NC}"
        echo -e "${CYAN}â•‘${NC}${BLUE}              ${PROJECT_DESC}              ${NC}${CYAN}â•‘${NC}"
        echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    else
        # ASCIIæ–‡å­—ã®ã¿
        echo -e "${CYAN}============================================================${NC}"
        echo -e "${CYAN}|${NC}${PURPLE}${BOLD}                    ${PROJECT_NAME}                    ${NC}${CYAN}|${NC}"
        echo -e "${CYAN}|${NC}${BLUE}              ${PROJECT_DESC}              ${NC}${CYAN}|${NC}"
        echo -e "${CYAN}============================================================${NC}"
    fi
    echo ""
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±
    echo -e "${GREEN}â–¶ Project Information${NC}"
    echo "  â”œâ”€ Name: ${PROJECT_NAME}"
    echo "  â”œâ”€ Type: ${PROJECT_TYPE}"
    echo "  â”œâ”€ Version: ${PROJECT_VERSION}"
    echo "  â”œâ”€ Status: ${PROJECT_STATUS}"
    echo "  â””â”€ Description: ${PROJECT_DESC}"
    echo ""
    
    # ç’°å¢ƒæƒ…å ±
    echo -e "${GREEN}â–¶ Environment${NC}"
    echo "  â”œâ”€ Current Dir: $(pwd)"
    echo "  â”œâ”€ Time: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "  â”œâ”€ User: $(whoami)"
    echo "  â”œâ”€ Git Branch: $(git branch --show-current 2>/dev/null || echo 'Not a git repo')"
    
    # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
    if command -v git >/dev/null 2>&1 && [ -d .git ]; then
        LAST_COMMIT=$(git log -1 --pretty=format:"%h - %s" 2>/dev/null || echo "No commits")
        echo "  â”œâ”€ Last Commit: ${LAST_COMMIT}"
    fi
    
    # é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    echo "  â”œâ”€ Node.js: $(node -v 2>/dev/null || echo 'Not installed')"
    echo "  â”œâ”€ npm: $(npm -v 2>/dev/null || echo 'Not installed')"
    echo "  â”œâ”€ Python: $(python3 --version 2>&1 | cut -d' ' -f2 || python --version 2>&1 | cut -d' ' -f2 || echo 'Not installed')"
    echo "  â”œâ”€ Docker: $(docker --version 2>/dev/null | cut -d' ' -f3 | cut -d',' -f1 || echo 'Not installed')"
    
    # TODOã‚«ã‚¦ãƒ³ãƒˆï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚Œã°ï¼‰
    if command -v grep >/dev/null 2>&1; then
        TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.js" --include="*.ts" --include="*.py" --include="*.go" . 2>/dev/null | wc -l)
        if [ "$TODO_COUNT" -gt 0 ]; then
            echo "  â””â”€ TODOs: ${TODO_COUNT} items"
        else
            echo "  â””â”€ TODOs: None"
        fi
    else
        echo "  â””â”€ TODOs: Unable to count"
    fi
    echo ""
    
    # æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆ.claude-projectã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    if [ -f ".claude-project" ]; then
        echo -e "${GREEN}â–¶ Tech Stack${NC}"
        # ã“ã“ã§JSONã‹ã‚‰æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        echo "  â””â”€ See .claude-project for details"
        echo ""
    fi
    
    # ã‚¯ã‚¤ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰
    echo -e "${GREEN}â–¶ Quick Commands${NC}"
    
    # MakefileãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    if [ -f "Makefile" ] || [ -f "makefile" ]; then
        echo "  â”œâ”€ make help    - Show available commands"
        echo "  â”œâ”€ make info    - Show this information"
    fi
    
    # package.jsonãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    if [ -f "package.json" ]; then
        echo "  â”œâ”€ npm start    - Start development"
        echo "  â”œâ”€ npm test     - Run tests"
        echo "  â”œâ”€ npm run build - Build project"
    fi
    
    # requirements.txtãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        echo "  â”œâ”€ pip install -r requirements.txt - Install dependencies"
    fi
    
    echo "  â””â”€ [Type your command to begin]"
    echo ""
    
    # ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${CYAN}Ready to start working on ${PROJECT_NAME}!${NC}"
    echo -e "${WHITE}Type your command or question to begin...${NC}"
    echo ""
}

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šã™ã‚‹é–¢æ•°
setup_prompt() {
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã‚€
    load_project_config
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆbashã¨zshã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
    if [ -n "$BASH_VERSION" ]; then
        # Bashç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        export PS1="\[\033[0;36m\][${PROJECT_NAME}]\[\033[0m\] \w $ "
    elif [ -n "$ZSH_VERSION" ]; then
        # Zshç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        export PROMPT="%F{cyan}[${PROJECT_NAME}]%f %~ $ "
    fi
    
    # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
    export CLAUDE_PROJECT_NAME="${PROJECT_NAME}"
    export CLAUDE_PROJECT_TYPE="${PROJECT_TYPE}"
    export CLAUDE_PROJECT_VERSION="${PROJECT_VERSION}"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã‚€
    load_project_config
    
    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    case "${1:-}" in
        "--prompt")
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®ã¿ï¼ˆé™ã‹ã«å®Ÿè¡Œï¼‰
            setup_prompt
            ;;
        "--info")
            # æƒ…å ±è¡¨ç¤ºã®ã¿
            show_project_info
            ;;
        *)
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæƒ…å ±è¡¨ç¤ºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
            show_project_info
            setup_prompt
            ;;
    esac
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®ç¢ºèª
if [ -f "CLAUDE.md" ] || [ -f ".claude-project" ]; then
    main
else
    echo -e "${RED}Error: Not in a Claude-enabled project directory${NC}"
    echo "Please ensure you have CLAUDE.md and .claude-project files in your project root."
    exit 1
fi